<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>D3 Network Demo — Simulated Subreddit Dataset</title>
<style>
  :root {
    --pad: 18px;
    --border: #ddd;
    --text: #1a1a1a;
    --muted: #666;
    --bg: #fff;
  }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color: var(--text);
    background: var(--bg);
  }
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 16px;
  }
  h1 {
    font-size: 18px;
    margin: 0 0 8px 0;
  }
  .sub {
    color: var(--muted);
    font-size: 13px;
    line-height: 1.35;
    margin-bottom: 12px;
  }
  .panel {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 14px;
    align-items: start;
  }
  @media (max-width: 900px) {
    .panel { grid-template-columns: 1fr; }
  }
  .controls {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
  }
  .controls h2 {
    font-size: 14px;
    margin: 0 0 10px 0;
  }
  .row {
    margin: 10px 0;
  }
  label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  select, input[type="range"] {
    width: 100%;
  }
  .small {
    font-size: 12px;
    color: var(--muted);
  }
  .viz {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
  }
  #chart {
    width: 100%;
    height: 650px; /* IMPORTANT: gives the iframe/container a real height */
  }
  .legend {
    margin-top: 10px;
    font-size: 12px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .legend .bar {
    width: 220px;
    height: 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: linear-gradient(90deg, #b2182b, #fddbc7, #d1e5f0, #2166ac);
  }
  /* Tooltip */
  .tip {
    position: fixed;
    pointer-events: none;
    max-width: 360px;
    background: rgba(255,255,255,0.96);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 12px;
    line-height: 1.3;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    opacity: 0;
    transition: opacity 120ms ease;
  }
  .tip b { font-size: 13px; }
  .tip .meta { color: var(--muted); margin-top: 6px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Interactive Network Demo (D3) — Simulated Subreddits</h1>
  <div class="sub">
    Nodes are subreddits. Node <b>color</b> encodes the human-to-bot ratio (H÷B). Node <b>size</b> can encode subscribers or daily posts.
    Edge <b>thickness</b> can encode subscriber overlap (0–1) or cross-post volume.
    <br/>Tip: drag nodes; scroll or trackpad to zoom; click a node to highlight its neighbors.
  </div>

  <div class="panel">
    <div class="controls">
      <h2>Controls</h2>

      <div class="row">
        <label for="nodeSize">Node size encodes</label>
        <select id="nodeSize">
          <option value="subscribers" selected>Total subscribers</option>
          <option value="daily_posts">Daily new posts</option>
        </select>
      </div>

      <div class="row">
        <label for="edgeMetric">Edge thickness encodes</label>
        <select id="edgeMetric">
          <option value="overlap" selected>Subscriber overlap index (0–1)</option>
          <option value="crossposts">Cross-post volume (count)</option>
        </select>
      </div>

      <div class="row">
        <label for="edgeThreshold">Edge visibility threshold</label>
        <input id="edgeThreshold" type="range" min="0" max="1" step="0.01" value="0.05"/>
        <div class="small" id="edgeThresholdLabel">Show edges with overlap ≥ 0.05</div>
      </div>

      <div class="row">
        <label for="charge">Layout “repulsion” (spread nodes out)</label>
        <input id="charge" type="range" min="-1200" max="-50" step="10" value="-420"/>
        <div class="small" id="chargeLabel">Charge: -420</div>
      </div>

      <div class="row">
        <div class="small">
          <b>Pedagogy note.</b> This demo is intentionally “honest” about scale: the SVG viewBox is fixed and uses
          <code>preserveAspectRatio="xMidYMid meet"</code>, so the network’s geometry will not be stretched by your LMS container.
        </div>
      </div>
    </div>

    <div class="viz">
      <div id="chart"></div>
      <div class="legend">
        <span><b>Color</b>: Human-to-bot ratio (low → high)</span>
        <span class="bar" aria-hidden="true"></span>
        <span class="small">(hover nodes for exact values)</span>
      </div>
    </div>
  </div>
</div>

<div class="tip" id="tip"></div>

<!-- D3 via CDN. For maximum portability, download d3.v7.min.js and reference it locally instead. -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --------------------------
// 1) DATA (embedded JSON)
// --------------------------
const DATA = {"nodes": [{"id": "SR 1", "label": "Subreddit 1", "subscribers": 2450000.0, "daily_posts": 8200.0, "human": 2156000.0, "bot": 294000.0, "hbr": 7.3, "annotation": "Large general-interest community (\u2248 r/worldnews scale). High subscriber count \u2192 large node. Moderate bot activity."}, {"id": "SR 2", "label": "Subreddit 2", "subscribers": 320000.0, "daily_posts": 1100.0, "human": 275000.0, "bot": 45000.0, "hbr": 6.1, "annotation": "Mid-size topical community (\u2248 r/history scale). Healthy human majority."}, {"id": "SR 3", "label": "Subreddit 3", "subscribers": 185000.0, "daily_posts": 2900.0, "human": 92500.0, "bot": 92500.0, "hbr": 1.0, "annotation": "\u26a0 High bot presence. Equal human/bot split \u2014 suspicious activity pattern common in engagement-farmed communities."}, {"id": "SR 4", "label": "Subreddit 4", "subscribers": 78000.0, "daily_posts": 430.0, "human": 66300.0, "bot": 11700.0, "hbr": 5.7, "annotation": "Small niche community. Low post volume but strong human base."}, {"id": "SR 5", "label": "Subreddit 5", "subscribers": 3100000.0, "daily_posts": 11500.0, "human": 2728000.0, "bot": 372000.0, "hbr": 7.3, "annotation": "Largest community in dataset \u2014 hub node. Comparable to r/AskReddit scale. Gateway for cross-posts."}, {"id": "SR 6", "label": "Subreddit 6", "subscribers": 420000.0, "daily_posts": 1750.0, "human": 352800.0, "bot": 67200.0, "hbr": 5.3, "annotation": "Mid-size community with above-average post volume relative to subscribers."}, {"id": "SR 7", "label": "Subreddit 7", "subscribers": 210000.0, "daily_posts": 3400.0, "human": 84000.0, "bot": 126000.0, "hbr": 0.7, "annotation": "\u26a0 Bot-majority community. Bots outnumber humans \u2014 extreme case, relevant for inauthentic-behaviour studies."}, {"id": "SR 8", "label": "Subreddit 8", "subscribers": 495000.0, "daily_posts": 2100.0, "human": 421750.0, "bot": 73250.0, "hbr": 5.8, "annotation": "Upper-mid community, close to 500k ceiling. Active and predominantly human."}, {"id": "SR 9", "label": "Subreddit 9", "subscribers": 140000.0, "daily_posts": 1980.0, "human": 70000.0, "bot": 70000.0, "hbr": 1.0, "annotation": "\u26a0 High bot presence. Mirrors Subreddit 3; useful comparison case."}, {"id": "SR 10", "label": "Subreddit 10", "subscribers": 265000.0, "daily_posts": 890.0, "human": 231950.0, "bot": 33050.0, "hbr": 7.0, "annotation": "Mid-size community. Relatively quiet (low daily posts) but large and human-dominant."}], "links": [{"source": "SR 1", "target": "SR 2", "overlap": 0.18, "crossposts": 45.0}, {"source": "SR 1", "target": "SR 3", "overlap": 0.08, "crossposts": 12.0}, {"source": "SR 1", "target": "SR 4", "overlap": 0.06, "crossposts": 6.0}, {"source": "SR 1", "target": "SR 5", "overlap": 0.55, "crossposts": 120.0}, {"source": "SR 1", "target": "SR 6", "overlap": 0.14, "crossposts": 33.0}, {"source": "SR 1", "target": "SR 7", "overlap": 0.07, "crossposts": 8.0}, {"source": "SR 1", "target": "SR 8", "overlap": 0.19, "crossposts": 54.0}, {"source": "SR 1", "target": "SR 9", "overlap": 0.09, "crossposts": 10.0}, {"source": "SR 1", "target": "SR 10", "overlap": 0.12, "crossposts": 38.0}, {"source": "SR 2", "target": "SR 3", "overlap": 0.12, "crossposts": 9.0}, {"source": "SR 2", "target": "SR 4", "overlap": 0.11, "crossposts": 4.0}, {"source": "SR 2", "target": "SR 5", "overlap": 0.2, "crossposts": 67.0}, {"source": "SR 2", "target": "SR 6", "overlap": 0.57, "crossposts": 88.0}, {"source": "SR 2", "target": "SR 7", "overlap": 0.09, "crossposts": 5.0}, {"source": "SR 2", "target": "SR 8", "overlap": 0.16, "crossposts": 18.0}, {"source": "SR 2", "target": "SR 9", "overlap": 0.1, "crossposts": 7.0}, {"source": "SR 2", "target": "SR 10", "overlap": 0.14, "crossposts": 14.0}, {"source": "SR 3", "target": "SR 4", "overlap": 0.07, "crossposts": 3.0}, {"source": "SR 3", "target": "SR 5", "overlap": 0.1, "crossposts": 19.0}, {"source": "SR 3", "target": "SR 6", "overlap": 0.11, "crossposts": 11.0}, {"source": "SR 3", "target": "SR 7", "overlap": 0.53, "crossposts": 62.0}, {"source": "SR 3", "target": "SR 8", "overlap": 0.08, "crossposts": 6.0}, {"source": "SR 3", "target": "SR 9", "overlap": 0.48, "crossposts": 55.0}, {"source": "SR 3", "target": "SR 10", "overlap": 0.06, "crossposts": 4.0}, {"source": "SR 4", "target": "SR 5", "overlap": 0.08, "crossposts": 11.0}, {"source": "SR 4", "target": "SR 6", "overlap": 0.13, "crossposts": 9.0}, {"source": "SR 4", "target": "SR 7", "overlap": 0.05, "crossposts": 2.0}, {"source": "SR 4", "target": "SR 8", "overlap": 0.17, "crossposts": 14.0}, {"source": "SR 4", "target": "SR 9", "overlap": 0.06, "crossposts": 3.0}, {"source": "SR 4", "target": "SR 10", "overlap": 0.09, "crossposts": 7.0}, {"source": "SR 5", "target": "SR 6", "overlap": 0.22, "crossposts": 55.0}, {"source": "SR 5", "target": "SR 7", "overlap": 0.11, "crossposts": 14.0}, {"source": "SR 5", "target": "SR 8", "overlap": 0.25, "crossposts": 89.0}, {"source": "SR 5", "target": "SR 9", "overlap": 0.12, "crossposts": 18.0}, {"source": "SR 5", "target": "SR 10", "overlap": 0.6, "crossposts": 145.0}, {"source": "SR 6", "target": "SR 7", "overlap": 0.1, "crossposts": 6.0}, {"source": "SR 6", "target": "SR 8", "overlap": 0.21, "crossposts": 22.0}, {"source": "SR 6", "target": "SR 9", "overlap": 0.09, "crossposts": 8.0}, {"source": "SR 6", "target": "SR 10", "overlap": 0.18, "crossposts": 19.0}, {"source": "SR 7", "target": "SR 8", "overlap": 0.07, "crossposts": 4.0}, {"source": "SR 7", "target": "SR 9", "overlap": 0.51, "crossposts": 49.0}, {"source": "SR 7", "target": "SR 10", "overlap": 0.08, "crossposts": 3.0}, {"source": "SR 8", "target": "SR 9", "overlap": 0.08, "crossposts": 6.0}, {"source": "SR 8", "target": "SR 10", "overlap": 0.15, "crossposts": 17.0}, {"source": "SR 9", "target": "SR 10", "overlap": 0.07, "crossposts": 4.0}]};

// --------------------------
// 2) STAGE GEOMETRY (true aspect ratio + explicit padding model)
// --------------------------
const PAD = { top: 26, right: 26, bottom: 26, left: 26 };
const WORLD = { W: 1000, H: 650 };            // logical coordinate system
const INNER = {
  x: PAD.left,
  y: PAD.top,
  w: WORLD.W - PAD.left - PAD.right,
  h: WORLD.H - PAD.top - PAD.bottom
};

// --------------------------
// 3) SVG SETUP (no stretching)
// --------------------------
const host = d3.select("#chart");
const svg = host.append("svg")
  .attr("viewBox", `0 0 ${WORLD.W} ${WORLD.H}`)
  .attr("preserveAspectRatio", "xMidYMid meet")
  .style("width", "100%")
  .style("height", "100%")
  .style("display", "block");

const zoomLayer = svg.append("g")
  .attr("transform", `translate(${INNER.x},${INNER.y})`);

const g = zoomLayer.append("g");   // this is what we zoom/pan

// Background hit area for zoom (so students don’t need to “aim” at blank SVG)
zoomLayer.append("rect")
  .attr("x", 0).attr("y", 0)
  .attr("width", INNER.w).attr("height", INNER.h)
  .attr("fill", "transparent")
  .lower();

// --------------------------
// 4) SCALES
// --------------------------
const sizeScales = {
  subscribers: d3.scaleSqrt()
    .domain(d3.extent(DATA.nodes, d => d.subscribers))
    .range([7, 26]),
  daily_posts: d3.scaleSqrt()
    .domain(d3.extent(DATA.nodes, d => d.daily_posts))
    .range([7, 26]),
};

// Human-to-bot ratio: use a perceptual diverging palette.
// Low ratio (bot-heavy) → “warm”; high ratio (human-heavy) → “cool”.
const color = d3.scaleSequential()
  .domain(d3.extent(DATA.nodes, d => d.hbr))
  .interpolator(d3.interpolateRdYlBu);

// Edge thickness scales (computed dynamically in update())
function edgeWidthScale(metric, links) {
  const vals = links.map(d => d[metric]);
  const max = d3.max(vals);
  if (metric === "overlap") {
    return d3.scaleLinear().domain([0, 1]).range([0.2, 7]);
  }
  return d3.scaleSqrt().domain([0, max || 1]).range([0.2, 7]);
}

// --------------------------
// 5) UI STATE
// --------------------------
let state = {
  nodeSize: "subscribers",
  edgeMetric: "overlap",
  edgeThreshold: 0.05,
  charge: -420
};

// --------------------------
// 6) BUILD GRAPH ELEMENTS
// --------------------------
const linkG = g.append("g").attr("class", "links");
const nodeG = g.append("g").attr("class", "nodes");

const tip = d3.select("#tip");

const nodes = DATA.nodes.map(d => ({...d}));
const linksAll = DATA.links.map(d => ({...d}));

// Helper: neighbors map for highlighting
const neighbor = new Map();
linksAll.forEach(l => {
  neighbor.set(`${l.source}→${l.target}`, true);
  neighbor.set(`${l.target}→${l.source}`, true);
});
function isNeighbor(a, b) {
  return neighbor.get(`${a}→${b}`) || false;
}

// --------------------------
// 7) FORCE SIMULATION
// --------------------------
const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(linksAll).id(d => d.id).distance(85).strength(0.18))
  .force("charge", d3.forceManyBody().strength(state.charge))
  .force("center", d3.forceCenter(INNER.w/2, INNER.h/2))
  .force("collide", d3.forceCollide().radius(d => sizeScales[state.nodeSize](d[state.nodeSize]) + 4))
  .alpha(1);

// --------------------------
// 8) ZOOM / PAN (map-like)
// --------------------------
const zoom = d3.zoom()
  .scaleExtent([0.45, 5])
  .on("zoom", (event) => {
    g.attr("transform", event.transform);
  });

svg.call(zoom);

// --------------------------
// 9) RENDER + UPDATE LOOP
// --------------------------
let selected = null;

function update() {
  const metric = state.edgeMetric;

  // Set threshold label and slider range logic
  const thrLabel = d3.select("#edgeThresholdLabel");
  if (metric === "overlap") {
    d3.select("#edgeThreshold")
      .attr("min", 0).attr("max", 1).attr("step", 0.01);
    thrLabel.text(`Show edges with overlap ≥ ${state.edgeThreshold.toFixed(2)}`);
  } else {
    const maxCP = d3.max(linksAll, d => d.crossposts) || 1;
    d3.select("#edgeThreshold")
      .attr("min", 0).attr("max", maxCP).attr("step", 1);
    thrLabel.text(`Show edges with cross-posts ≥ ${Math.round(state.edgeThreshold)}`);
  }

  // Filter links by threshold
  const links = linksAll.filter(d => d[metric] >= state.edgeThreshold);

  // Update force link list
  simulation.force("link").links(links);

  // Update collide radius to match chosen node sizing metric
  simulation.force("collide").radius(d => sizeScales[state.nodeSize](d[state.nodeSize]) + 4);

  // Update charge force
  simulation.force("charge").strength(state.charge);

  const w = edgeWidthScale(metric, linksAll);

  // ----- LINKS -----
  const linkSel = linkG.selectAll("line")
    .data(links, d => `${d.source}|${d.target}|${metric}`);

  linkSel.exit().remove();

  const linkEnter = linkSel.enter().append("line")
    .attr("stroke", "#777")
    .attr("stroke-opacity", 0.25)
    .attr("stroke-linecap", "round");

  const linkMerged = linkEnter.merge(linkSel)
    .attr("stroke-width", d => w(d[metric]));

  // ----- NODES -----
  const nodeSel = nodeG.selectAll("circle")
    .data(nodes, d => d.id);

  nodeSel.exit().remove();

  const nodeEnter = nodeSel.enter().append("circle")
    .attr("r", d => sizeScales[state.nodeSize](d[state.nodeSize]))
    .attr("fill", d => color(d.hbr))
    .attr("stroke", "#222")
    .attr("stroke-width", 0.8)
    .attr("cursor", "grab")
    .on("mouseenter", (event, d) => {
      tip.style("opacity", 1);
      tip.html(`
        <b>${d.label}</b> <span style="color:#666">(${d.id})</span><br/>
        Subscribers: ${Math.round(d.subscribers).toLocaleString()}<br/>
        Daily posts (avg): ${Math.round(d.daily_posts).toLocaleString()}<br/>
        Human: ${Math.round(d.human).toLocaleString()} &nbsp; | &nbsp; Bot: ${Math.round(d.bot).toLocaleString()}<br/>
        Human-to-bot ratio (H÷B): <b>${d.hbr.toFixed(1)}</b>
        <div class="meta">${d.annotation}</div>
      `);
    })
    .on("mousemove", (event) => {
      tip.style("left", (event.clientX + 14) + "px")
         .style("top", (event.clientY + 14) + "px");
    })
    .on("mouseleave", () => {
      tip.style("opacity", 0);
    })
    .on("click", (event, d) => {
      event.stopPropagation();
      selected = (selected && selected.id === d.id) ? null : d;

      nodeG.selectAll("circle")
        .attr("opacity", n => !selected ? 1 : (n.id === selected.id || isNeighbor(selected.id, n.id) ? 1 : 0.18))
        .attr("stroke-width", n => !selected ? 0.8 : (n.id === selected.id ? 2.2 : 0.8));

      linkG.selectAll("line")
        .attr("stroke-opacity", l => {
          if (!selected) return 0.25;
          const s = (typeof l.source === "object") ? l.source.id : l.source;
          const t = (typeof l.target === "object") ? l.target.id : l.target;
          return (s === selected.id || t === selected.id) ? 0.55 : 0.06;
        });
    });

  // dragging
  nodeEnter.call(d3.drag()
    .on("start", (event, d) => {
      if (!event.active) simulation.alphaTarget(0.2).restart();
      d.fx = d.x; d.fy = d.y;
    })
    .on("drag", (event, d) => {
      d.fx = clamp(event.x, 0, INNER.w);
      d.fy = clamp(event.y, 0, INNER.h);
    })
    .on("end", (event, d) => {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    })
  );

  nodeEnter.merge(nodeSel)
    .transition().duration(250)
    .attr("r", d => sizeScales[state.nodeSize](d[state.nodeSize]))
    .attr("fill", d => color(d.hbr));

  // Clear highlight when clicking background
  svg.on("click", () => {
    selected = null;
    nodeG.selectAll("circle").attr("opacity", 1).attr("stroke-width", 0.8);
    linkG.selectAll("line").attr("stroke-opacity", 0.25);
  });

  // Tick handler (with boundary clamping)
  simulation.on("tick", () => {
    // Keep nodes in bounds of the INNER stage
    nodes.forEach(d => {
      d.x = clamp(d.x, 0, INNER.w);
      d.y = clamp(d.y, 0, INNER.h);
    });

    linkMerged
      .attr("x1", d => (typeof d.source === "object" ? d.source.x : nodes.find(n => n.id === d.source).x))
      .attr("y1", d => (typeof d.source === "object" ? d.source.y : nodes.find(n => n.id === d.source).y))
      .attr("x2", d => (typeof d.target === "object" ? d.target.x : nodes.find(n => n.id === d.target).x))
      .attr("y2", d => (typeof d.target === "object" ? d.target.y : nodes.find(n => n.id === d.target).y));

    nodeG.selectAll("circle")
      .attr("cx", d => d.x)
      .attr("cy", d => d.y);
  });

  simulation.alpha(0.9).restart();
}

function clamp(v, lo, hi) {
  return Math.max(lo, Math.min(hi, v));
}

// --------------------------
// 10) WIRE UI EVENTS
// --------------------------
d3.select("#nodeSize").on("change", (event) => {
  state.nodeSize = event.target.value;
  update();
});

d3.select("#edgeMetric").on("change", (event) => {
  state.edgeMetric = event.target.value;
  // reset threshold to a sensible default per metric
  state.edgeThreshold = (state.edgeMetric === "overlap") ? 0.05 : 10;
  d3.select("#edgeThreshold").property("value", state.edgeThreshold);
  update();
});

d3.select("#edgeThreshold").on("input", (event) => {
  state.edgeThreshold = +event.target.value;
  update();
});

d3.select("#charge").on("input", (event) => {
  state.charge = +event.target.value;
  d3.select("#chargeLabel").text(`Charge: ${state.charge}`);
  update();
});

// First render
update();
</script>
  
<footer style="
  margin-top: 40px;
  padding: 18px 0;
  font-size: 0.85rem;
  color: #555;
  border-top: 1px solid #ddd;
  text-align: center;
">
  <div>
    © 2025 Keren Wang
  </div>
  <div>
    Code licensed under the MIT License.
  </div>
  <div>
    Instructional materials licensed under
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener">
      CC BY-NC-ND 4.0
    </a>.
  </div>
</footer>
</body>
</html>
